<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>$TAGE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: white; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; padding: 20px; padding-bottom: 92px; box-sizing: border-box; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .glass { background: rgba(20,20,20,0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .nav-active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .hidden { display: none; }
        .tabs-header { display: flex; gap: 8px; margin-bottom: 12px; }
        .tabs-header .tab { flex: 1; text-align: center; padding: 10px 8px; border-radius: 10px; background: rgba(255,255,255,0.06); font-size: 12px; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .tabs-header .tab.active { background: #2563eb; color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader-spin { width: 40px; height: 40px; border: 4px solid #1e293b; border-top-color: #38bdf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; background: #1e293b; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: transparent; color: #94a3b8; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: #38bdf8; color: #0f172a; }
        .lb-card { background: #1e293b; border-radius: 16px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #334155; }
        .lb-info { display: flex; align-items: center; gap: 12px; }
        .lb-rank { font-weight: 800; color: #38bdf8; width: 30px; }
        .lb-name { font-weight: 600; color: white; }
        .lb-points { color: #38bdf8; font-weight: 700; }
        .lb-link { color: #64748b; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer; }
        .lb-link.active { color: #38bdf8; text-shadow: 0 0 8px rgba(56, 189, 248, 0.5); }
        .task-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .task-info h4 { margin: 0 0 4px 0; font-weight: 700; }
        .task-info p { margin: 0; color: #38bdf8; font-size: 12px; }
        .nav-tabs { position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; background: #000; padding: 20px 0; border-top: 1px solid #1e293b; z-index: 1000; }
        .nav-tabs .tab { background: none !important; border: none !important; outline: none !important; color: #64748b; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; transition: all 0.2s ease; text-align: center; }
        .nav-tabs .tab.active { color: #38bdf8; text-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }
        .watch-btn { background: #2563eb; color: white; padding: 15px 40px; border-radius: 12px; font-size: 18px; font-weight: 800; border: none; width: 80%; }
        .spinner { width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite; }
        .view-section { min-height: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="p-6">
    <div id="loading-screen" style="position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div id="loading-text" style="color: #38bdf8; font-family: monospace; font-size: 14px; margin-bottom: 15px; letter-spacing: 3px; text-transform: uppercase;">
            Initializing...
        </div>
        <div style="width: 60%; height: 2px; background: #1e293b; border-radius: 5px; overflow: hidden;">
            <div id="progress" style="width: 0%; height: 100%; background: #38bdf8; box-shadow: 0 0 10px #38bdf8; transition: width 0.4s ease;"></div>
        </div>
    </div>

    <div id="analyze-screen" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center p-10 text-center hidden">
        <h1 class="text-6xl font-black italic italic mb-4">$TAGE</h1>
        <p id="status" class="text-blue-500 text-xs font-bold tracking-widest uppercase mb-6">Analyzing Profile...</p>
        <div class="w-full bg-zinc-900 h-1.5 rounded-full overflow-hidden">
            <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
        </div>
        <div id="result" class="mt-10 hidden">
            <h2 id="reward-text" class="text-7xl font-black mb-10">0</h2>
            <button onclick="enterApp()" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase">Claim Reward</button>
        </div>
    </div>

        <div id="main-dashboard" class="hidden app-container">
        <div class="flex justify-between items-center mb-10">
            <div>
                <p id="username-display" class="font-black text-xl">@Guest</p>
                <p id="uid-display" class="text-[10px] text-zinc-500 font-bold uppercase">UID: 000000</p>
            </div>
            <div class="glass px-4 py-2 rounded-xl text-blue-500 font-black text-xl" id="balance-display">0</div>
        </div>

        <div id="view-home" class="view-section">
            <div class="glass p-10 rounded-[2rem] text-center">
                <h3 class="font-black uppercase mb-4">Daily Check-in</h3>
                <button onclick="watchAd()" class="watch-btn font-black uppercase">Watch Video</button>
                <p id="ad-reward-text" class="text-xs text-zinc-300 mt-2">+1,000 $TAGE per video</p>
                <p class="text-xs text-zinc-400 mt-3">Ads Today: <span id="ad-count-display">0/10</span></p>
            </div>
        </div>

        <div id="tasks-page" class="view-section hidden" style="display:none; min-height: 0; flex-direction: column;">
            <h3 class="font-black text-2xl uppercase mb-6">Tasks</h3>
            <div class="tabs-header">
                <div class="tab active" onclick="switchTab('today', event)">Today</div>
                <div class="tab" onclick="switchTab('partner', event)">Partners</div>
                <div class="tab" onclick="switchTab('completed', event)">Completed</div>
            </div>

            <div id="today" class="tab-content active">
                <div class="space-y-3">
                    <div class="glass p-5 rounded-2xl flex justify-between items-center">
                        <p class="font-bold">Follow $TAGE on X</p>
                        <button id="task-btn" onclick="completeTask()" class="bg-blue-600 px-4 py-1 rounded-lg text-xs font-bold uppercase">Go</button>
                    </div>
                    <div class="glass p-5 rounded-2xl flex justify-between items-center">
                        <p class="font-bold">Like this post</p>
                        <button id="task-btn-9001" onclick="startTask(9001, 'https://x.com/your_handle/status/1234567890', 500)" class="bg-blue-600 px-4 py-1 rounded-lg text-xs font-bold uppercase">Go</button>
                    </div>
                    <div class="glass p-5 rounded-2xl flex justify-between items-center">
                        <p class="font-bold">Comment this post</p>
                        <button id="task-btn-9002" onclick="startTask(9002, 'https://x.com/your_handle/status/1234567890', 500)" class="bg-blue-600 px-4 py-1 rounded-lg text-xs font-bold uppercase">Go</button>
                    </div>
                    <div class="glass p-5 rounded-2xl flex justify-between items-center">
                        <p class="font-bold">Repost this post</p>
                        <button id="task-btn-9003" onclick="startTask(9003, 'https://x.com/your_handle/status/1234567890', 500)" class="bg-blue-600 px-4 py-1 rounded-lg text-xs font-bold uppercase">Go</button>
                    </div>
                    <div class="glass p-5 rounded-2xl flex justify-between items-center">
                        <p class="font-bold">Watch an Ad</p>
                        <button onclick="watchAd()" class="bg-blue-600 px-4 py-1 rounded-lg text-xs font-bold uppercase">Go</button>
                    </div>
                </div>
            </div>

            <div id="partner" class="tab-content">
                <div id="partner-tasks-container"></div>
            </div>

            <div id="completed" class="tab-content">
                <div id="completed-list" class="glass p-5 rounded-2xl text-sm text-zinc-300">No tasks completed yet.</div>
            </div>
        </div>

        <div id="refs-page" class="view-section hidden">
            <h3 class="font-black text-2xl uppercase mb-6">Referrals</h3>
            <div class="glass p-5 rounded-2xl space-y-4">
                <p class="text-sm text-zinc-300">Share your link and earn 20% commission.</p>
                <p id="ref-link-display" class="text-xs text-blue-400 break-all">Loading...</p>
                <button onclick="copyLink()" class="w-full bg-blue-600 py-3 rounded-xl font-black uppercase">Copy Link</button>
            </div>
            <div class="glass p-5 rounded-2xl mt-4 milestone-container">
                <h3 class="font-black uppercase mb-3">Referral Milestones</h3>
                <div id="milestone-list"></div>
            </div>
        </div>

        <div id="leaderboard-page" class="view-section hidden" style="display:none; padding: 20px; overflow-y:auto;">
            <h2 style="text-align: center;" class="font-black text-2xl mb-6">LEADERBOARD</h2>
            <div id="league-display" style="text-align:center; padding: 20px; background: #111; border-radius: 15px; margin-bottom: 16px;">
                <h2 id="league-name" style="margin:0; font-weight: 900; letter-spacing: 2px; font-size: 22px;">BRONZE LEAGUE</h2>
                <div style="width: 100%; height: 8px; background: #1e293b; border-radius: 10px; margin-top: 10px; overflow: hidden;">
                    <div id="league-progress-fill" style="width: 0%; height: 100%; background: #38bdf8; transition: width 0.5s ease;"></div>
                </div>
                <p id="next-league-text" style="font-size: 10px; color: #64748b; margin-top: 5px;">50,000 $TAGE TO SILVER</p>
            </div>
            <div class="lb-tabs" style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px;">
                <span onclick="loadLB('total')" id="tab-total" class="lb-link active">TOTAL POINTS</span>
                <span onclick="loadLB('refs')" id="tab-refs" class="lb-link">TOP REF</span>
            </div>
            <div id="lb-list"></div>
            <div id="sticky-rank" style="position: fixed; bottom: 80px; left:0; right:0; background:#1e293b; padding:15px; display:none; justify-content:space-between; border-top: 2px solid #38bdf8;">
                <span id="my-rank">#5,000 YOU</span>
                <span id="my-points" style="color:#38bdf8;">0 $TAGE</span>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="tab active" onclick="showPage('home')">
                <span style="font-size: 20px;"></span><br>Home
            </div>
            <div class="tab" onclick="showPage('tasks')">
                <span style="font-size: 20px;"></span><br>Tasks
            </div>
            <div class="tab" onclick="showPage('refs')">
                <span style="font-size: 20px;"></span><br>Refs
            </div>
            <div class="tab" onclick="showPage('leaderboard')">
                <span style="font-size: 20px;"></span><br>Leaderboard
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const BACKEND_URL = "https://tage-main-production.up.railway.app";
        const AdController = window.Adsgram ? window.Adsgram.init({ blockId: "23760" }) : null;
        const MILESTONES = [
            { type: 'friends', goal: 5, reward: 10000 },
            { type: 'friends', goal: 10, reward: 25000 },
            { type: 'friends', goal: 50, reward: 100000 },
            { type: 'friends', goal: 1000, reward: 1000000 }
        ];
        const LEAGUES = [
            { name: "BRONZE", min: 0, max: 50000, color: "#b45309" },
            { name: "SILVER", min: 50001, max: 250000, color: "#94a3b8" },
            { name: "GOLD", min: 250001, max: 1000000, color: "#fbbf24" },
            { name: "PLATINUM", min: 1000001, max: 5000000, color: "#a78bfa" },
            { name: "DIAMOND", min: 5000001, max: 20000000, color: "#38bdf8" },
            { name: "MASTER", min: 20000001, max: Infinity, color: "#f87171" }
        ];
        let user = { id: 0, username: "Guest", points: 0 };
        let currentUser = { id: 0, refCount: 0 };
        let currentLBTab = 'total';
        let pendingTelegramUser = null;

        function resolveDisplayName() {
            const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
            if (tgUser) {
                const value = {
                    username: tgUser.username || tgUser.first_name || "Guest",
                    id: tgUser.id || currentUser.id
                };
                localStorage.setItem('tage_user', JSON.stringify(value));
                return value.username;
            }

            const saved = localStorage.getItem('tage_user');
            if (saved) {
                const parsed = JSON.parse(saved);
                return parsed.username || "Guest";
            }
            return "Guest";
        }

        function formatPoints(value) {
            const n = Number(value) || 0;
            const compact = (num, suffix) =>
                `${new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(num).replace('.', ',')}${suffix}`;
            if (n >= 1_000_000_000) return compact(n / 1_000_000_000, 'B');
            if (n >= 1_000_000) return compact(n / 1_000_000, 'M');
            if (n >= 1_000) return compact(n / 1_000, 'K');
            return n.toLocaleString('en-US');
        }

        async function loadUserData(tgUser) {
            const userId = tgUser?.id || tg.initDataUnsafe.user?.id || 12345;
            const username = tgUser?.username || tgUser?.first_name || tg.initDataUnsafe.user?.username || "Guest";
            const referrerId = tg.initDataUnsafe.start_param || null;

            const checkRes = await fetch(`${BACKEND_URL}/check-user`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    telegram_id: userId,
                    username,
                    referrer_id: referrerId
                })
            });
            const data = await checkRes.json();
            user = data.user || {};
            currentUser.id = user.telegram_id || userId;
            currentUser.refCount = data.ref_count || 0;
            updateUI(user);
            initReferralPage();
            renderMilestones(currentUser.refCount);
            return data.isNewUser;
        }

        function getTodayAdCount(userData) {
            const today = new Date().toISOString().split('T')[0];
            return userData.last_ad_date === today ? (userData.ads_watched_today || 0) : 0;
        }

        function runAnalyzeAnimation() {
            document.getElementById('status').innerText = "Analyzing Profile...";
            document.getElementById('result').classList.add('hidden');

            let p = 0;
            const bar = document.getElementById('progress-bar');

            return new Promise((resolve) => {
                const int = setInterval(() => {
                    p++;
                    bar.style.width = p + "%";
                    if (p === 100) {
                        clearInterval(int);
                        document.getElementById('status').innerText = "VERIFIED";
                        document.getElementById('reward-text').innerText = formatPoints(user.points);
                        document.getElementById('result').classList.remove('hidden');
                        resolve();
                    }
                }, 20);
            });
        }

        function showMainDashboard() {
            document.getElementById('analyze-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('username-display').innerText = "@" + resolveDisplayName();
            document.getElementById('uid-display').innerText = "UID: " + (user.telegram_id || currentUser.id);
            updateUI(user);
        }

        function enterApp() {
            localStorage.setItem('isExistingUser', 'true');
            showMainDashboard();
        }

        function showView(name) {
            const pageMap = {
                home: 'view-home',
                tasks: 'tasks-page',
                referrals: 'refs-page',
                leaderboard: 'leaderboard-page'
            };
            const pageId = pageMap[name] || pageMap.home;

            document.querySelectorAll('.view-section').forEach(v => {
                v.classList.add('hidden');
                if (v.id === 'tasks-page' || v.id === 'leaderboard-page') v.style.display = 'none';
            });
            const target = document.getElementById(pageId);
            target.classList.remove('hidden');
            if (pageId === 'tasks-page' || pageId === 'leaderboard-page') target.style.display = 'block';

            const navItems = document.querySelectorAll('.nav-tabs .tab');
            navItems.forEach((item) => item.classList.remove('active'));
            const order = ['home', 'tasks', 'referrals', 'leaderboard'];
            const idx = order.indexOf(name);
            if (idx >= 0 && navItems[idx]) navItems[idx].classList.add('active');
            if (name === 'leaderboard') loadLeaderboard(currentLBTab);
            if (name === 'tasks') loadTaskCards();
        }

        function showPage(name) {
            if (name === 'refs') name = 'referrals';
            showView(name);
        }

        function switchTab(tabId, evt) {
            document.querySelectorAll('.tabs-header .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            evt.currentTarget.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        async function completeTask() {
            const userId = window.Telegram.WebApp.initDataUnsafe.user?.id || user.telegram_id;
            const taskId = "twitter_follow";

            // 1. Open the X link in a new tab
            window.open("https://x.com/your_handle", "_blank");

            // 2. Tell the backend to add points and mark task complete
            const response = await fetch(`${BACKEND_URL}/complete-task`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initData: tg.initData,
                    telegram_id: userId,
                    task_id: taskId
                })
            });

            if (response.ok) {
                user.points += 1000;
                user.completed_tasks = [...(user.completed_tasks || []), taskId];
                updateUI(user);
                alert("1,000 Points Added!");
            } else {
                const error = await response.json();
                alert(error.error || "Task claim failed");
            }
        }

        function startTask(taskId, link, points) {
            window.open(link, '_blank');

            const btn = document.getElementById(`task-btn-${taskId}`);
            btn.disabled = true;
            btn.style.background = "#334155";

            let timeLeft = 10;
            const timer = setInterval(() => {
                btn.innerText = `WAIT ${timeLeft}s`;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(timer);
                    btn.innerText = "CLAIM POINTS";
                    btn.style.background = "#2563eb";
                    btn.disabled = false;
                    btn.onclick = () => processManualClaim(taskId, points);
                }
            }, 1000);
        }

        async function processManualClaim(taskId, points) {
            const btn = document.getElementById(`task-btn-${taskId}`);
            btn.innerText = "VERIFYING...";

            const res = await fetch(`${BACKEND_URL}/claim-task`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uid: tg.initDataUnsafe?.user?.id || currentUser.id,
                    taskId: taskId,
                    task_reward: points,
                    initData: tg.initData
                })
            });

            if (res.ok) {
                btn.innerText = "CLAIMED âœ“";
                btn.style.background = "#059669";
                btn.disabled = true;
                user.points = (user.points || 0) + Number(points || 0);
                updateUI(user);
            } else {
                const err = await res.json().catch(() => ({}));
                btn.innerText = "CLAIM FAILED";
                btn.disabled = false;
                alert(err.error || err.message || "Claim failed. Try again.");
            }
        }

        async function loadTaskCards() {
            const response = await fetch(`${BACKEND_URL}/get-tasks?uid=${currentUser.id}`);
            const tasks = await response.json();
            const completedTaskIds = (user.completed_tasks || []).map((t) => Number(t));
            renderFilteredTasks(tasks || [], completedTaskIds);
        }

        function renderFilteredTasks(allTasks, completedTaskIds) {
            const container = document.getElementById('task-list-container') || document.getElementById('partner-tasks-container');
            const visibleTasks = (allTasks || []).filter((task) => !completedTaskIds.includes(Number(task.id)));
            container.innerHTML = visibleTasks.map(task => `
                <div class="task-card">
                    <div class="task-info">
                        <h4>${task.title}</h4>
                        <p>+${Number(task.points || task.reward || 0).toLocaleString()} $TAGE</p>
                    </div>
                    <button id="task-btn-${task.id || 0}" onclick="startTask(${task.id || 0}, '${task.link}', ${Number(task.points || task.reward || 0)})">GO</button>
                </div>
            `).join('');
        }

        async function watchAd() {
            try {
                if (!AdController) throw new Error("ad network offline");
                const result = await AdController.show();
                if (result && result.done) {
                    await claimAdReward();
                }
            } catch (error) {
                alert("The ad network is currently syncing. Please try again in 5 minutes!");
            }
        }

        async function claimAdReward() {
            const response = await fetch(`${BACKEND_URL}/add-ad-reward`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initData: tg.initData,
                    uid: currentUser.id,
                    amount: 1000
                })
            });

            const data = await response.json();
            if (response.ok) {
                user.points = data.newPoints;
                user.ads_watched_today = data.watchedToday;
                user.last_ad_date = new Date().toISOString().split('T')[0];
                document.getElementById('balance-display').innerText = formatPoints(data.newPoints);
                document.getElementById('ad-count-display').innerText = `${data.watchedToday}/10`;
                alert("Success! +1,000 $TAGE added to your balance.");
            } else {
                alert(data.error);
            }
        }

        function updateUI(userData) {
            const btn = document.getElementById('task-btn');
            const pointsEl = document.getElementById('balance-display');
            const adCounter = document.getElementById('ad-count-display');
            const completedList = document.getElementById('completed-list');

            if (pointsEl) pointsEl.innerText = formatPoints(userData.points || 0);
            updateLeague(userData.points || 0);
            if (adCounter) adCounter.innerText = `${getTodayAdCount(userData)}/10`;

            if (btn && userData.completed_tasks && userData.completed_tasks.includes('twitter_follow')) {
                btn.innerText = "CLAIMED";
                btn.disabled = true;
                btn.style.backgroundColor = "#6c757d";
                btn.style.cursor = "not-allowed";
            }

            if (completedList) {
                const done = userData.completed_tasks || [];
                completedList.innerText = done.length ? done.join(', ') : "No tasks completed yet.";
            }
        }

        function initReferralPage() {
            const userId = currentUser.id;
            const refLink = `https://t.me/TageTon_bot/app?startapp=${userId}`;
            document.getElementById('ref-link-display').innerText = refLink;
        }

        function copyLink() {
            const link = document.getElementById('ref-link-display').innerText;
            navigator.clipboard.writeText(link);
            alert("Referral link copied! You'll earn 20% from your friends' tasks.");
        }

        function claimMilestone(milestoneId) {
            alert(`Milestone ${milestoneId} claim requested.`);
        }

        async function loadLeaderboard() {
            const res = await fetch(`${BACKEND_URL}/leaderboard?sort=${currentLBTab}`);
            const data = await res.json();
            renderLeaderboard(data, currentLBTab);
        }

        function switchLB(type) {
            currentLBTab = type;
            document.querySelectorAll('.lb-link').forEach(el => el.classList.remove('active'));
            document.getElementById(type === 'total' ? 'tab-total' : 'tab-refs').classList.add('active');
            loadLeaderboard(type);
        }

        function loadLB(type) {
            switchLB(type);
        }

        function renderLeaderboard(data, type) {
            const container = document.getElementById('lb-list');
            const topList = Array.isArray(data) ? data : (Array.isArray(data?.top100) ? data.top100 : []);
            if (!topList.length) {
                container.innerHTML = '<div class="lb-card"><span class="lb-name">No users yet.</span></div>';
                document.getElementById('sticky-rank').style.display = 'none';
                return;
            }

            container.innerHTML = topList.map((u, i) => `
                <div class="lb-card">
                    <div class="lb-info">
                        <span class="lb-rank">#${i + 1}</span>
                        <span class="lb-name">@${u.username || "anon"}</span>
                    </div>
                    <span class="lb-points">${type === 'total' ? `${formatPoints(u.points || 0)} $TAGE` : `${u.ref_count || 0} Refs`}</span>
                </div>
            `).join('');

            const sticky = document.getElementById('sticky-rank');
            const myId = Number(tg?.initDataUnsafe?.user?.id || currentUser.id || 0);
            const amIInTop100 = topList.some((entry) => Number(entry.telegram_id || entry.id || 0) === myId);
            if (!amIInTop100 && Number(data?.userRank) > 100) {
                sticky.style.display = 'flex';
                document.getElementById('my-rank').innerText = `#${data.userRank} YOU`;
                document.getElementById('my-points').innerText = `${formatPoints(data.userPoints || user.points || 0)} $TAGE`;
            } else {
                sticky.style.display = 'none';
            }
        }

        function renderMilestones(refCount) {
            const el = document.getElementById('milestone-list');
            el.innerHTML = MILESTONES.map((m) => {
                const done = refCount >= m.goal;
                return `<div class="lb-card">
                    <div class="lb-info">
                        <span class="lb-name">${m.goal} Friends</span>
                    </div>
                    <span class="lb-points">${done ? 'Claimed' : `${m.reward.toLocaleString()} pts`}</span>
                </div>`;
            }).join('');
        }

        function updateMilestoneUI(currentRefs) {
            const milestones = [
                { key: 'ref_5', goal: 5, reward: 10000 },
                { key: 'ref_25', goal: 25, reward: 100000 },
                { key: 'ref_100', goal: 100, reward: 1000000 }
            ];

            const html = milestones.map(m => {
                const canClaim = currentRefs >= m.goal;
                return `
                    <div class="m-card" style="background:#0f172a; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="color:white; font-weight:bold;">Invite ${m.goal} Friends</div>
                            <div style="color:#38bdf8; font-size:12px;">+${m.reward.toLocaleString()} Points</div>
                        </div>
                        <button 
                            onclick="${canClaim ? `claimMilestone('${m.key}')` : 'void(0)'}"
                            style="
                                background: ${canClaim ? '#2563eb' : '#1e293b'};
                                color: ${canClaim ? 'white' : '#475569'};
                                border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold;
                                cursor: ${canClaim ? 'pointer' : 'not-allowed'};
                            ">
                            ${canClaim ? 'CLAIM' : 'LOCKED'}
                        </button>
                    </div>
                `;
            }).join('');
            document.getElementById('milestone-list').innerHTML = html;
        }

        function updateLeague(points) {
            const current = LEAGUES.find(l => points <= l.max) || LEAGUES[LEAGUES.length - 1];
            const next = LEAGUES[LEAGUES.indexOf(current) + 1];

            const leagueNameEl = document.getElementById('league-name');
            const fillEl = document.getElementById('league-progress-fill');
            const nextEl = document.getElementById('next-league-text');
            if (!leagueNameEl || !fillEl || !nextEl) return;

            leagueNameEl.innerText = `${current.name} LEAGUE`;
            leagueNameEl.style.color = current.color;

            if (next && Number.isFinite(current.max)) {
                const progress = ((points - current.min) / (current.max - current.min)) * 100;
                fillEl.style.width = `${Math.max(0, Math.min(progress, 100))}%`;
                nextEl.innerText = `${Math.max(0, current.max - points).toLocaleString('en-US')} $TAGE TO ${next.name}`;
            } else {
                fillEl.style.width = "100%";
                nextEl.innerText = "MAX LEAGUE REACHED";
            }
        }

        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        async function checkUserStatus(uid, username) {
            const response = await fetch(`${BACKEND_URL}/user-init`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid, username })
            });
            const userData = await response.json();

            if (userData.status === 'banned') {
                document.body.innerHTML = "<h1>YOUR ACCOUNT IS BANNED</h1>";
                return;
            }

            user = userData;
            currentUser.id = userData.telegram_id || uid;
            currentUser.refCount = Number(userData.referral_count || userData.ref_count || currentUser.refCount || 0);
            updateUI(user);
            initReferralPage();
            loadTaskCards();
            updateMilestoneUI(currentUser.refCount);

            showMainDashboard();
            showView('home');
        }

        function runCleanAnalysis() {
            const statusText = document.getElementById('loading-text');
            const bar = document.getElementById('progress');
            const steps = [
                { msg: "Connecting...", time: 700 },
                { msg: "Analyzing Profile...", time: 1300 },
                { msg: "Calculating Rewards...", time: 1000 },
                { msg: "Finalizing...", time: 800 }
            ];

            let current = 0;
            function process() {
                if (current < steps.length) {
                    statusText.innerText = steps[current].msg;
                    bar.style.width = ((current + 1) * 25) + "%";
                    setTimeout(() => { current++; process(); }, steps[current].time);
                } else {
                    const screen = document.getElementById('loading-screen');
                    screen.style.opacity = '0';
                    screen.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => { screen.style.display = 'none'; }, 500);
                }
            }
            process();
        }

        function startApp() {
            const tg = window.Telegram.WebApp;
            tg.ready();

            let checkCount = 0;
            const checkInterval = setInterval(() => {
                const user = tg.initDataUnsafe?.user;
                checkCount++;

                if (user) {
                    clearInterval(checkInterval);
                    pendingTelegramUser = user;
                    document.getElementById('username-display').innerText = `@${user.username || user.first_name}`;
                    document.getElementById('uid-display').innerText = `UID: ${user.id}`;
                    checkUserStatus(user.id, user.username || user.first_name);
                    runCleanAnalysis();
                } else if (checkCount >= 20) {
                    clearInterval(checkInterval);
                    alert("Telegram connection timeout. Please restart.");
                }
            }, 500);
        }

        startApp();
    </script>
</body>
</html>
