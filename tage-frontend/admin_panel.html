<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAGE Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 24px; }
        .container { max-width: 1000px; margin: 0 auto; display: grid; gap: 16px; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; }
        h3 { margin-top: 0; }
        input, select, button { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 10px; background: #0f172a; color: #e2e8f0; }
        button { background: #38bdf8; color: #0f172a; font-weight: 700; cursor: pointer; border: none; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #334155; padding: 8px; text-align: left; font-size: 13px; }
        .mini-btn { width: auto; margin: 0; padding: 6px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h3>Create New Task Card</h3>
            <input type="text" id="t-name" placeholder="Task Name (e.g., Follow X)">
            <input type="text" id="t-link" placeholder="Redirect Link">
            <input type="number" id="t-points" placeholder="Reward Points">
            <select id="t-cat">
                <option value="today">Today Tab</option>
                <option value="partner">Partner Tab</option>
            </select>
            <button onclick="adminAction('add_task', {name: document.getElementById('t-name').value, link: document.getElementById('t-link').value, points: document.getElementById('t-points').value, category: document.getElementById('t-cat').value})">Add Task</button>
        </div>

        <div class="card">
            <h3>Detailed User Info</h3>
            <table>
                <thead>
                    <tr>
                        <th>UID</th>
                        <th>Username</th>
                        <th>Total Points</th>
                        <th>Ads Today</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="user-rows"></tbody>
            </table>
        </div>
    </div>

    <script>
        const BACKEND_URL = "https://tage-main-production.up.railway.app";
        const SECRET_KEY = localStorage.getItem('admin_secret_key') || '';
        const ADMIN_ID = 1755569721;

        async function adminAction(action, payload) {
            const res = await fetch(`${BACKEND_URL}/admin/execute`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auth_key: SECRET_KEY,
                    admin_id: ADMIN_ID,
                    action: action,
                    payload: payload
                })
            });

            if (res.ok) {
                alert("Success!");
                fetchDetailedUsers();
            } else {
                alert("Failed.");
            }
        }

        async function fetchDetailedUsers() {
            const res = await fetch(`${BACKEND_URL}/admin/execute`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auth_key: SECRET_KEY,
                    admin_id: ADMIN_ID,
                    action: 'get_detailed_users',
                    payload: {}
                })
            });
            if (!res.ok) return;

            const data = await res.json();
            const tbody = document.getElementById('user-rows');
            tbody.innerHTML = (data || []).map(u => `
                <tr>
                    <td>${u.telegram_id ?? ''}</td>
                    <td>${u.username ?? ''}</td>
                    <td>${u.points ?? 0}</td>
                    <td>${u.ads_watched_today ?? 0}</td>
                    <td>${u.status ?? 'active'}</td>
                    <td>
                        <button class="mini-btn" onclick="adminAction('${(u.status === 'banned') ? 'unban_user' : 'ban_user'}', { uid: ${u.telegram_id} })">${(u.status === 'banned') ? 'Unban' : 'Ban'}</button>
                    </td>
                </tr>
            `).join('');
        }

        fetchDetailedUsers();
    </script>
</body>
</html>
